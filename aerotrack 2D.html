<!DOCTYPE html>
<html lang="ro">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroTrack - Portfolio Showcase</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg-panel: rgba(15, 23, 42, 0.95);
            --border: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #fbbf24;
            --accent-blue: #38bdf8;
            --danger: #ef4444;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: var(--text-main);
        }

        #map {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .plane-icon svg {
            filter: drop-shadow(0px 3px 6px rgba(0, 0, 0, 0.9));
            transition: transform 0.2s linear;
        }

        .airport-icon {
            background: #3b82f6;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        }

        .airport-tooltip {
            background: var(--bg-panel);
            color: #fff;
            border: 1px solid var(--border);
            font-weight: bold;
        }

        .panel {
            position: absolute;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        #sidebar {
            top: 20px;
            left: 20px;
            width: 350px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .search-container {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .search-container input {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            outline: none;
            box-sizing: border-box;
            font-size: 14px;
            transition: 0.3s;
        }

        .search-container input:focus {
            border-color: var(--accent-blue);
        }

        #flight-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .flight-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
            transition: 0.2s;
            border-left: 4px solid transparent;
        }

        .flight-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .flight-item.active {
            background: rgba(56, 189, 248, 0.1);
            border-left-color: var(--accent-blue);
        }

        .f-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .f-callsign {
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .f-speed {
            font-size: 13px;
            color: var(--accent);
            font-weight: bold;
        }

        .route-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            color: #e2e8f0;
        }

        .route-airport {
            font-weight: bold;
            color: var(--accent-blue);
        }

        #info-panel {
            top: 20px;
            right: 20px;
            width: 340px;
            padding: 0;
            display: none;
            overflow: hidden;
        }

        .info-header {
            background: linear-gradient(180deg, rgba(56, 189, 248, 0.15) 0%, rgba(0, 0, 0, 0) 100%);
            padding: 25px 20px 15px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .info-header h2 {
            margin: 0;
            font-size: 30px;
            color: #fff;
            letter-spacing: 1px;
        }

        .info-header .model {
            color: var(--accent-blue);
            font-size: 14px;
            font-weight: bold;
            margin-top: 5px;
        }

        .info-header .reg {
            margin: 5px 0 0 0;
            font-size: 12px;
            color: var(--text-muted);
        }

        .route-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
        }

        .main-route {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .main-ap {
            text-align: center;
            width: 40%;
        }

        .main-ap h3 {
            margin: 0;
            font-size: 32px;
            color: var(--text-main);
            font-weight: 800;
        }

        .main-ap span {
            font-size: 12px;
            color: var(--text-muted);
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-track {
            width: 100%;
            height: 6px;
            background: #1e293b;
            border-radius: 3px;
            position: relative;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .progress-icon {
            position: absolute;
            top: -7px;
            margin-left: -10px;
            font-size: 14px;
            left: 0%;
            transform: rotate(90deg);
            filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.8));
            transition: left 0.1s linear;
        }

        .info-body {
            padding: 20px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .data-item {
            display: flex;
            flex-direction: column;
        }

        .data-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .data-val {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent);
        }

        #unlock-btn {
            display: none;
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            z-index: 1000;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            font-size: 14px;
            transition: 0.2s;
        }

        #unlock-btn:hover {
            background: #dc2626;
            transform: translateX(-50%) scale(1.05);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <button id="unlock-btn" onclick="unlockCamera()">❌ Eliberează Camera</button>

    <div id="sidebar" class="panel">
        <div class="header">
            <h1>✈️ AeroTrack Pro</h1>
            <div class="status-bar">
                <span>Avioane în aer: <b id="plane-count" style="color: #fff;">0</b></span>
                <span style="font-weight: bold; color: #10b981;">Simulare Activă</span>
            </div>
        </div>
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Caută zbor (ex: WZZ, RYR)..." onkeyup="filterFlights()">
        </div>
        <div id="flight-list"></div>
    </div>

    <div id="info-panel" class="panel">
        <div class="info-header">
            <h2 id="p-callsign">ZBOR</h2>
            <div class="model" id="p-model">Aeronava Comerciala</div>
            <p class="reg" id="p-country">Reg: Țară</p>
        </div>

        <div class="route-section">
            <div class="main-route">
                <div class="main-ap">
                    <h3 id="p-route-from">OTP</h3>
                    <span id="p-city-from">București</span>
                </div>
                <div style="color: var(--text-muted); font-size: 12px;">LA</div>
                <div class="main-ap">
                    <h3 id="p-route-to">LHR</h3>
                    <span id="p-city-to">Londra</span>
                </div>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="p-progress-bar"></div>
                <div class="progress-icon" id="p-progress-icon">✈️</div>
            </div>
        </div>

        <div class="info-body">
            <div class="data-grid">
                <div class="data-item">
                    <span class="data-label">Altitudine</span>
                    <span class="data-val"><span id="p-alt">-</span> m</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Viteză (Sol)</span>
                    <span class="data-val"><span id="p-speed">-</span> km/h</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Direcție</span>
                    <span class="data-val"><span id="p-heading">-</span>°</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Sistem</span>
                    <span class="data-val" style="color: #38bdf8; font-size: 14px;">Motor Fizic 2D</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- INIȚIALIZARE HARTĂ ---
        const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([48, 15], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap', maxZoom: 12 }).addTo(map);

        // --- BAZA DE DATE (Aeroporturi & Companii) ---
        const airports = [
            { code: "OTP", city: "București", lat: 44.57, lng: 26.10, country: "România" },
            { code: "CLJ", city: "Cluj-Napoca", lat: 46.78, lng: 23.68, country: "România" },
            { code: "IAS", city: "Iași", lat: 47.17, lng: 27.62, country: "România" },
            { code: "TSR", city: "Timișoara", lat: 45.81, lng: 21.33, country: "România" },
            { code: "LHR", city: "Londra", lat: 51.47, lng: -0.45, country: "UK" },
            { code: "FRA", city: "Frankfurt", lat: 50.03, lng: 8.57, country: "Germania" },
            { code: "CDG", city: "Paris", lat: 49.00, lng: 2.55, country: "Franța" },
            { code: "AMS", city: "Amsterdam", lat: 52.30, lng: 4.76, country: "Olanda" },
            { code: "FCO", city: "Roma", lat: 41.80, lng: 12.24, country: "Italia" },
            { code: "VIE", city: "Viena", lat: 48.11, lng: 16.56, country: "Austria" },
            { code: "IST", city: "Istanbul", lat: 41.27, lng: 28.73, country: "Turcia" },
            { code: "MAD", city: "Madrid", lat: 40.47, lng: -3.56, country: "Spania" },
            { code: "ATH", city: "Atena", lat: 37.93, lng: 23.94, country: "Grecia" },
            { code: "WAW", city: "Varșovia", lat: 52.16, lng: 20.96, country: "Polonia" },
            { code: "MUC", city: "Munchen", lat: 48.35, lng: 11.78, country: "Germania" },
            { code: "BCN", city: "Barcelona", lat: 41.29, lng: 2.07, country: "Spania" },
            { code: "LIS", city: "Lisabona", lat: 38.77, lng: -9.13, country: "Portugalia" },
            { code: "CPH", city: "Copenhaga", lat: 55.61, lng: 12.65, country: "Danemarca" }
        ];

        const airlines = [
            { prefix: "WZZ", name: "Wizz Air", model: "Airbus A321neo" },
            { prefix: "RYR", name: "Ryanair", model: "Boeing 737-800" },
            { prefix: "ROT", name: "Tarom", model: "Boeing 737-700" },
            { prefix: "DLH", name: "Lufthansa", model: "Airbus A320-200" },
            { prefix: "EZY", name: "EasyJet", model: "Airbus A319" },
            { prefix: "BAW", name: "British Airways", model: "Airbus A320neo" },
            { prefix: "AFR", name: "Air France", model: "Airbus A350-900" }
        ];

        // Desenăm aeroporturile
        airports.forEach(ap => {
            const icon = L.divIcon({ className: 'airport-icon', iconSize: [8, 8] });
            L.marker([ap.lat, ap.lng], { icon: icon }).addTo(map).bindTooltip(`${ap.code} - ${ap.city}`, { className: 'airport-tooltip', direction: 'top' });
        });

        let planesMap = new Map();
        let selectedFlightId = null;
        let isFollowing = false;
        let flightPathLine = null;

        function getPlaneIcon(heading, isSelected) {
            const color = isSelected ? '#ef4444' : '#fbbf24';
            const size = isSelected ? 36 : 24;
            const svg = `
                <div style="transform: rotate(${heading}deg); width: ${size}px; height: ${size}px;">
                    <svg viewBox="0 0 24 24" width="${size}" height="${size}">
                        <path fill="${color}" d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z" />
                    </svg>
                </div>
            `;
            return L.divIcon({ html: svg, className: 'plane-icon', iconSize: [size, size], iconAnchor: [size / 2, size / 2] });
        }

        function calculateHeading(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) - Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            let brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }

        function calcDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // --- GENERATOR DE AVIOANE VIRTUALE ---
        function spawnFlight() {
            // Alegem 2 aeroporturi diferite
            let fromAp = airports[Math.floor(Math.random() * airports.length)];
            let toAp = airports[Math.floor(Math.random() * airports.length)];
            while (fromAp.code === toAp.code) { toAp = airports[Math.floor(Math.random() * airports.length)]; }

            // Alegem compania
            const airline = airlines[Math.floor(Math.random() * airlines.length)];
            const flightNumber = Math.floor(Math.random() * 8999) + 1000;
            const callsign = airline.prefix + flightNumber;
            const id = callsign;

            // Parametrii zborului
            const speedKmh = Math.floor(Math.random() * 200) + 700; // 700 - 900 km/h
            const alt = Math.floor(Math.random() * 3000) + 8000; // 8000 - 11000m
            const heading = Math.round(calculateHeading(fromAp.lat, fromAp.lng, toAp.lat, toAp.lng));
            const totalDistance = calcDistance(fromAp.lat, fromAp.lng, toAp.lat, toAp.lng);

            // Setăm o poziție de start random pe rută (să nu plece toate fix din aeroport la refresh)
            const startProgress = Math.random() * 0.8;

            const icon = getPlaneIcon(heading, false);
            // Pentru început îl punem la coordonatele de plecare, motorul fizic îl va muta instant
            const marker = L.marker([fromAp.lat, fromAp.lng], { icon: icon }).addTo(map);
            marker.on('click', () => focusOnFlight(id));

            planesMap.set(id, {
                id: id,
                callsign: callsign,
                model: airline.model,
                origin: fromAp.country,
                route: { from: fromAp, to: toAp },
                speed: speedKmh,
                realAlt: alt,
                heading: heading,
                totalDistance: totalDistance,
                progress: startProgress, // 0.0 la 1.0
                marker: marker,
                pathHistory: []
            });
        }

        // Creăm 70 de avioane la start
        for (let i = 0; i < 70; i++) spawnFlight();
        filterFlights();

        // --- MOTORUL FIZIC LOCAL (Rulează impecabil la 60 FPS) ---
        let lastTime = Date.now();

        function animatePhysics() {
            const now = Date.now();
            const dt = (now - lastTime) / 1000; // Secunde de la ultimul frame
            lastTime = now;

            const bounds = map.getBounds();

            planesMap.forEach((plane, id) => {
                // Viteza este în km/h. Distanța e în km.
                // Mutăm avionul de-a lungul rutei (în procente)
                const speedPerSecond = plane.speed / 3600; // Câți km parcurge pe secundă
                const progressToAdd = (speedPerSecond * dt) / plane.totalDistance;

                plane.progress += progressToAdd;

                // Dacă a ajuns la destinație (100%)
                if (plane.progress >= 1) {
                    map.removeLayer(plane.marker);
                    if (id === selectedFlightId) unlockCamera();
                    planesMap.delete(id);
                    spawnFlight(); // Naștem altul în loc
                    filterFlights();
                    document.getElementById('plane-count').innerText = planesMap.size;
                    return; // Trecem la următorul
                }

                // Calculăm noile coordonate precise pe traiectorie (Interpolare liniară)
                plane.currentLat = plane.route.from.lat + (plane.route.to.lat - plane.route.from.lat) * plane.progress;
                plane.currentLng = plane.route.from.lng + (plane.route.to.lat - plane.route.from.lng) * plane.progress; // Aproximare flat-earth pentru distanțe medii e vizual ok
                // Corecție pentru curba Pământului pe plan 2D
                plane.currentLng = plane.route.from.lng + (plane.route.to.lng - plane.route.from.lng) * plane.progress;


                // Actualizăm grafic doar dacă e pe ecran
                if (bounds.contains([plane.currentLat, plane.currentLng])) {
                    plane.marker.setLatLng([plane.currentLat, plane.currentLng]);
                }

                // Salvăm istoric pentru dâră (la fiecare 60 de frame-uri = ~1 sec)
                if (Math.random() < 0.05) {
                    plane.pathHistory.push([plane.currentLat, plane.currentLng]);
                    if (plane.pathHistory.length > 20) plane.pathHistory.shift();

                    if (id === selectedFlightId && flightPathLine) {
                        flightPathLine.setLatLngs(plane.pathHistory);
                    }
                }
            });

            // Dacă urmărim unul
            if (isFollowing && selectedFlightId && planesMap.has(selectedFlightId)) {
                const p = planesMap.get(selectedFlightId);
                map.setView([p.currentLat, p.currentLng], map.getZoom(), { animate: false });
                updateProgressBar(p);
            }

            requestAnimationFrame(animatePhysics);
        }

        document.getElementById('plane-count').innerText = planesMap.size;
        animatePhysics();

        function updateProgressBar(plane) {
            let percent = plane.progress * 100;
            if (percent < 3) percent = 3;
            if (percent > 97) percent = 97;

            document.getElementById('p-progress-bar').style.width = `${percent}%`;
            document.getElementById('p-progress-icon').style.left = `${percent}%`;
        }

        // --- INTERFAȚA ---
        function filterFlights() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const listContainer = document.getElementById('flight-list');
            listContainer.innerHTML = '';

            const allPlanes = Array.from(planesMap.values());
            const filtered = allPlanes.filter(p => p.callsign.toLowerCase().includes(searchTerm)).slice(0, 50);

            filtered.forEach(plane => {
                const div = document.createElement('div');
                div.className = `flight-item ${plane.id === selectedFlightId ? 'active' : ''}`;
                div.onclick = () => focusOnFlight(plane.id);

                div.innerHTML = `
                    <div class="f-top">
                        <div class="f-callsign">
                            <svg viewBox="0 0 24 24" width="16" height="16" style="transform: rotate(45deg);"><path fill="${plane.id === selectedFlightId ? '#ef4444' : '#fbbf24'}" d="M21,16V14L13,9V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z"/></svg>
                            ${plane.callsign}
                        </div>
                        <div class="f-speed">${plane.speed} km/h</div>
                    </div>
                    <div class="route-display">
                        <span class="route-airport">${plane.route.from.code}</span>
                        <span>────── ✈️ ──────</span>
                        <span class="route-airport">${plane.route.to.code}</span>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }

        function focusOnFlight(id) {
            if (selectedFlightId && planesMap.has(selectedFlightId)) {
                const old = planesMap.get(selectedFlightId);
                old.marker.setIcon(getPlaneIcon(old.heading, false));
                old.marker.setZIndexOffset(0);
                if (flightPathLine) map.removeLayer(flightPathLine);
            }

            selectedFlightId = id;
            isFollowing = true;

            const plane = planesMap.get(id);
            if (plane) {
                plane.marker.setIcon(getPlaneIcon(plane.heading, true));
                plane.marker.setZIndexOffset(1000);

                // Desenăm dâra (care pleacă de la origine până unde e acum)
                const fullPath = [[plane.route.from.lat, plane.route.from.lng], [plane.currentLat, plane.currentLng]];
                flightPathLine = L.polyline(fullPath, { color: '#ef4444', weight: 3, opacity: 0.8, dashArray: "10, 10" }).addTo(map);

                map.setView([plane.currentLat, plane.currentLng], 8);

                updateInfoPanel(plane);
                filterFlights();
                document.getElementById('unlock-btn').style.display = 'block';
            }
        }

        function unlockCamera() {
            if (selectedFlightId && planesMap.has(selectedFlightId)) {
                const plane = planesMap.get(selectedFlightId);
                plane.marker.setIcon(getPlaneIcon(plane.heading, false));
                plane.marker.setZIndexOffset(0);
            }
            if (flightPathLine) {
                map.removeLayer(flightPathLine);
                flightPathLine = null;
            }
            isFollowing = false;
            selectedFlightId = null;
            document.getElementById('unlock-btn').style.display = 'none';
            document.getElementById('info-panel').style.display = 'none';
            filterFlights();
        }

        function updateInfoPanel(plane) {
            const panel = document.getElementById('info-panel');
            panel.style.display = 'block';

            document.getElementById('p-callsign').innerText = plane.callsign;
            document.getElementById('p-model').innerText = plane.model;
            document.getElementById('p-country').innerText = "Reg: " + plane.origin;

            document.getElementById('p-route-from').innerText = plane.route.from.code;
            document.getElementById('p-city-from').innerText = plane.route.from.city;
            document.getElementById('p-route-to').innerText = plane.route.to.code;
            document.getElementById('p-city-to').innerText = plane.route.to.city;

            // Facem mici fluctuații la viteză și altitudine ca să pară ultra-realist
            setInterval(() => {
                if (selectedFlightId !== plane.id) return;
                const speedFluctuation = Math.floor(Math.random() * 5) - 2;
                const altFluctuation = Math.floor(Math.random() * 20) - 10;
                document.getElementById('p-speed').innerText = plane.speed + speedFluctuation;
                document.getElementById('p-alt').innerText = plane.realAlt + altFluctuation;
            }, 2000);

            document.getElementById('p-speed').innerText = plane.speed;
            document.getElementById('p-alt').innerText = plane.realAlt;
            document.getElementById('p-heading').innerText = plane.heading;

            updateProgressBar(plane);
        }

    </script>
</body>

</html>